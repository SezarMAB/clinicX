-- Create dental_charts table for H2 database
-- H2 uses JSON instead of JSONB
CREATE TABLE IF NOT EXISTS dental_charts (
    id UUID DEFAULT RANDOM_UUID() PRIMARY KEY,
    patient_id UUID NOT NULL UNIQUE,
    chart_data JSON NOT NULL DEFAULT '{"meta": {"version": "1.0", "lastUpdated": null, "updatedBy": null}, "teeth": {}}',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_dental_chart_patient 
        FOREIGN KEY (patient_id) 
        REFERENCES patients(id) 
        ON DELETE CASCADE
);

-- Create index on patient_id for fast lookups
CREATE INDEX IF NOT EXISTS idx_dental_charts_patient_id ON dental_charts(patient_id);

-- Initialize dental charts for all existing patients without charts
INSERT INTO dental_charts (patient_id, chart_data, created_at, updated_at)
SELECT 
    p.id,
    '{"meta": {"version": "1.0", "lastUpdated": null, "updatedBy": null}, "teeth": {"11": {"tooth_id": "11", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "12": {"tooth_id": "12", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "13": {"tooth_id": "13", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "14": {"tooth_id": "14", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "15": {"tooth_id": "15", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "16": {"tooth_id": "16", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "17": {"tooth_id": "17", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "18": {"tooth_id": "18", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "21": {"tooth_id": "21", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "22": {"tooth_id": "22", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "23": {"tooth_id": "23", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "24": {"tooth_id": "24", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "25": {"tooth_id": "25", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "26": {"tooth_id": "26", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "27": {"tooth_id": "27", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "28": {"tooth_id": "28", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "31": {"tooth_id": "31", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "32": {"tooth_id": "32", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "33": {"tooth_id": "33", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "34": {"tooth_id": "34", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "35": {"tooth_id": "35", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "36": {"tooth_id": "36", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "37": {"tooth_id": "37", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "38": {"tooth_id": "38", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "41": {"tooth_id": "41", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "42": {"tooth_id": "42", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "43": {"tooth_id": "43", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "44": {"tooth_id": "44", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "45": {"tooth_id": "45", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "46": {"tooth_id": "46", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "47": {"tooth_id": "47", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}, "48": {"tooth_id": "48", "condition": "healthy", "surfaces": {"mesial": {"condition": "healthy"}, "distal": {"condition": "healthy"}, "occlusal": {"condition": "healthy"}, "buccal": {"condition": "healthy"}, "lingual": {"condition": "healthy"}, "incisal": {"condition": "healthy"}, "cervical": {"condition": "healthy"}, "root": {"condition": "healthy"}}, "flags": {"impacted": false, "mobile": false, "periapical": false, "abscess": false}}}}' AS chart_data,
    CURRENT_TIMESTAMP,
    CURRENT_TIMESTAMP
FROM patients p
WHERE NOT EXISTS (
    SELECT 1 FROM dental_charts dc WHERE dc.patient_id = p.id
);